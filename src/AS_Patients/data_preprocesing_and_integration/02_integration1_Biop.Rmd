---
title: "AS_annotation"
output: html_document
date: '2022-03-09'

---

<!--
#-------------------------------------------------------------------------------
# This script performs several actions in order to perform
# a first step filtering:
# - Clusterization
# - Manual annotation of major cell types
# - Filter out cells based on low quality clustering (LowQC and erythrocytes)

# Author: Carlos Simon Foundation (Raul PM @supermegamio, Diego AC @diegoamoros)
# Date: 2022-03-09
#-------------------------------------------------------------------------------
#Former 09032022_AS_clusters_id.Rmd
-->

```{r}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      error = FALSE, comment = NA, cache = FALSE,
                      R.options = list(width = 320), fig.align = "center",
                      out.width = "95%", out.width = 3160, fig.width = 12,
                      fig.height = 10)
```

```{r}
library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(dittoSeq)
library(ggpubr)
library(dplyr)
library(yaml)
library(this.path)
library(clustree)

## Load config.yml file
find_config <- function(names = c("config.yaml", "config.yml")) {
  currrent.path <- dirname(this.path::this.path())
  dirs <- unique(c(currrent.path, dirname(currrent.path)))
  for (d in dirs) {
    for (nm in names) {
      p <- file.path(d, nm)
      if (file.exists(p))
        return(normalizePath(p, winslash = "/", mustWork = TRUE))
    }
  }
  stop("config.yaml|config.yml not found: ",
       paste(dirs, collapse = " o "), call. = FALSE)
}

config <- yaml.load_file(find_config())



## Count matrices procesed by Cell Bender (h5 format)
input_folder <- config$processed_data$dir

## QC plots, QC csv and count matrices processed and filtered (h5seurat format)
output_folder <- config$integration1_data$dir
dir.create(output_folder, recursive = TRUE, showWarnings = FALSE)

qc_folder <- config$integration1_data$qc_dir
dir.create(qc_folder, recursive = TRUE, showWarnings = FALSE)

# Load Input Dataset
sc_AS <- LoadH5Seurat(file = file.path(input_folder, 
                                       config$processed_data$file))

# Load gene annotations
annotations <- readRDS( config$annotation_data$file_annotations) 

```


# To perform clustree to find the optimal resolution

```{r}
DimPlot(sc_AS, group.by = "seurat_clusters", label = TRUE)

clus_vector <- c(0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5,1.6,1.7
                 ,1.8,1.9,2,2.1,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,3)

for (x in clus_vector) {
  sc_AS <- FindClusters(sc_AS, verbose = FALSE, resolution = x)
  print(x)
}
clustree_all <- clustree(x = sc_AS, prefix = "SCT_snn_res.", show_axis = TRUE)
ggsave(clustree_all,
       filename = file.path(qc_folder,"clusstree_SCT.svg"),
       device = "svg", dpi = 320, width = 12, height = 24)

```


## Resolution 0.7
```{r}
sc_AS <- FindClusters(sc_AS, verbose = FALSE, resolution = 0.7)
sc_AS <- SetIdent(object = sc_AS, value = "SCT_snn_res.0.7")
DimPlot(sc_AS, group.by = "SCT_snn_res.0.7", label = TRUE)

DefaultAssay(object = sc_AS) <- "RNA"
sc_AS <- NormalizeData(sc_AS, assay = "RNA")
gc()
sc_cluster_07_markers <- FindAllMarkers(sc_AS, assay = "RNA", min.pct = 0.3)

```



```{r}
sc_cluster_07_markers <- sc_cluster_07_markers %>%
    left_join(y = unique(annotations[, c("gene_name", "description")]),
               by = c("gene" = "gene_name"))

patient_color <- RColorBrewer::brewer.pal(n = length(unique(sc_AS$Patient)),
                                          name = "Set3")

umap1 <- DimPlot(object = sc_AS, group.by = "orig.ident", label = FALSE,
                 raster = TRUE) + NoLegend()
umap2 <- DimPlot(object = sc_AS, group.by = "SCT_snn_res.0.7"
                 , label = TRUE,  raster = TRUE)
umap3 <- DimPlot(object = sc_AS, group.by = "Patient", label = TRUE,
                 cols = patient_color,  raster = TRUE)
umap4 <- DimPlot(object = sc_AS, group.by = "Treatment_stage", label = TRUE,
                  raster = TRUE)
multiplot_map <- ggarrange(umap1, umap2, umap3, umap4, ncol = 2, nrow = 2)


ggsave(filename = file.path(qc_folder,"umap_multi_res07.svg"),
       device = "svg", dpi = 320, width = 16, height = 16)

vln_plot1 <- dittoSeq::dittoPlot(object = sc_AS, var = "nFeature_RNA",
                                 split.by = "SCT_snn_res.0.7",
                                 group.by = "Treatment_stage")

ggsave(filename = file.path(qc_folder,"vln_multi_res07.svg"),
       device = "svg", dpi = 320, width = 16, height = 16)
tapply(sc_AS$nFeature_RNA, sc_AS$SCT_snn_res.0.7, summary)
tapply(sc_AS$mitoRatio, sc_AS$SCT_snn_res.0.7, summary)

```

```{r}
vln_plot2 <- dittoSeq::dittoBarPlot(object = sc_AS, var = "Patient",
                                    group.by = "SCT_snn_res.0.7")
ggsave(filename = file.path(qc_folder,"02-barplot_multi_res07.svg"),
       device = "svg", dpi = 320, width = 10, height = 10)

sc_cluster_07_markers %>%
    group_by(cluster) %>%
    top_n(n = 7, wt = avg_log2FC) -> top10
dot_no <- DotPlot(object = sc_AS, assay = "RNA",
                  features = unique(top10$gene),
                  group.by = "SCT_snn_res.0.7",
                  cols = "RdYlBu") +
  theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust = 1)) + 
  NoLegend()
ggsave(filename = file.path(qc_folder,"02-dotplot_multi_res07.svg"),
       plot = dot_no, device = "svg", dpi = 320, width = 24, height = 10)


inmmune_clusters <- c(6,9,20,23,18)
sc_cluster_07_markers %>%
    group_by(cluster) %>%
    top_n(n = 30, wt = avg_log2FC) -> top10

top10_inmune <- top10[which(top10$cluster %in% inmmune_clusters),]

dot_inmune <- DotPlot(object = sc_AS[,which(sc_AS$SCT_snn_res.0.7 %in%
                                              inmmune_clusters)],
                      assay = "RNA", features = unique(top10_inmune$gene),
                      group.by = "SCT_snn_res.0.7", cols = "RdYlBu") +
  theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust = 1)) +
  NoLegend()

ggsave(filename = file.path(qc_folder,"02-dotplot_inmmune_res07.svg"),
  plot = dot_inmune, device = "svg", dpi = 320, width = 24, height = 4)



```

## Manual annotation

0:  Stromal cells
1:  Stromal cells
10: Endothelium
11: Stressed stromal cells
12: Mix of LowQC and erythrocyte cells -
13: AS cluster -. Maybe is a cell population that are reacting a
    abberant vasculagenesis. Positivie for AIF1
14: Seem like a epithelial cluster, but have low genes per cells and
    only present in one sample.
15: A central cluster with undeterminated cells and not clear gene signature
16: Epithelial cells
17: Mix of LowQC and erythrocyte cells
18: Macrophages
19: Myofibroblasts
2:  Epithelium

20: Cytotoxic NK, Perforin and CD16++(FCGR3A)
[https://www.frontiersin.org/files/Articles/622306/fimmu-12-622306-HTML/image_m/fimmu-12-622306-g001.jpg](paper)

21: Ciliated epithelium
22: Cycling stromal cells
23: DC
24: Bcells
25: Stromal cells
26: LQ cells?Â¿ majority one cluster
27: Stromal cells TPSB2
28: Mast cells
29: Epithelial cells
3: Stromal
4: Stromal
5: Stromal
6: T cells
7: Erythocites
8: Perivascular
9: NKs

```{r}
cluster_id <- c(0,1,10,11,12,13,14,15,16,17,18,19,2,20,
                21,22,23,24,25,26,27,28,29,3,4,5,6,7,8,9)
cluster_label <- c("Stromal","Stromal","Endothelium","Stromal",
                   "LQ-Ery","AS","LQ-Ery","LQ-Ery","Epithelium",
                   "LQ-Ery","Macrophages","Myofibroblasts",
                   "Epithelium","Cytotoxic NK","Ciliated Epithelium",
                   "Stromal","DC","B cells","Epithelium","Stromal",
                   "LQ-Ery","Mast cells","Epithelium","LQ-Ery","Stromal",
                   "Stromal","T cells", "LQ-Ery", "Perivascular","NK")
cluster_label_ext <- c("Stromal","Stromal","Endothelium","Stromal_SS","LQ-Ery",
                       "AS","LQ-Ery","LQ-Ery","Epithelium","LQ-Ery"
                       ,"Macrophages","Myofibroblasts","Epithelium"
                       ,"Cytotoxic NK_FCGR3A","Ciliated Epithelium",
                       "Stromal_cc","DC","B cells","Epithelium_KRT19",
                       "Stromal_PLCG2","LQ-Ery","Mast cells","Epithelium",
                       "LQ-Ery","Stromal","Stromal","T cells","LQ-Ery",
                       "Perivascular","NK")

names(cluster_label) <- cluster_id
names(cluster_label_ext) <- cluster_id


cell_type_AS <- plyr::mapvalues(x = sc_AS$SCT_snn_res.0.7,
                                to = cluster_label, from = names(cluster_label))
cell_type_AS_ext <- plyr::mapvalues(x = sc_AS$SCT_snn_res.0.7,
                                    to = cluster_label_ext,
                                     from = names(cluster_label_ext))
sc_AS$cell_type_AS <- cell_type_AS
sc_AS$cell_type_AS_ext <- cell_type_AS_ext

DimPlot(sc_AS,group.by = "cell_type_AS", label = TRUE)
DimPlot(sc_AS,group.by = "cell_type_AS_ext", label = TRUE)

## Filter out low quality and/or erythrocytes
sc_AS <- sc_AS[,which(!(sc_AS$cell_type_AS %in% c("LQ-Ery","AS")))]


## Create plots
umap <- DimPlot(object = sc_AS, group.by = "cell_type_AS",
                label = TRUE, raster = TRUE) +
  ggtitle(paste0("Integration1 - ", ncol(sc_AS), " cells"))

ggsave(umap, filename = file.path(qc_folder,"First_integration.svg"),
       device = "svg", dpi = 320, width = 8, height = 6)

DefaultAssay(sc_AS) <- "RNA"
sc_AS <- DietSeurat(sc_AS, assays = "RNA")



## Save processed Seurat object
SaveH5Seurat(
  object = sc_AS, 
  filename = file.path(output_folder, config$integration1_data$file))


```
